<!doctype html>
<html lang="ru">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover" />
<title>Городская Служба ДТП | Воронеж — Запись на осмотр</title>
<style>
  /* --- Reset & base --- */
  :root{
    --bg1: linear-gradient(135deg,#0f1724 0%, #082032 100%);
    --card:#0b1220;
    --accent:#00b894;
    --glass: rgba(255,255,255,0.04);
    --muted: rgba(255,255,255,0.6);
    --success: #27ae60;
    --danger: #ff4757;
    --glass-2: rgba(255,255,255,0.03);
  }
  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0;
    font-family: Inter, system-ui, -apple-system, "Helvetica Neue", Arial;
    background: var(--bg1);
    color: #e6eef8;
    -webkit-font-smoothing:antialiased;
    -webkit-touch-callout:none;
    -webkit-tap-highlight-color: transparent;
    display:flex;
    align-items:center;
    justify-content:center;
    padding:20px;
  }

  /* --- Layout --- */
  .wrap{
    width:100%;
    max-width:920px;
    display:grid;
    grid-template-columns: 1fr 420px;
    gap:22px;
    align-items:start;
    animation: appear .6s ease both;
  }
  @media (max-width:820px){
    .wrap{grid-template-columns:1fr; padding-bottom:40px}
  }

  /* --- Left panel (hero + instructions) --- */
  .hero{
    background: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    border-radius:18px;
    padding:26px;
    box-shadow: 0 6px 30px rgba(0,0,0,0.6);
    border: 1px solid rgba(255,255,255,0.03);
    position:relative;
    overflow:hidden;
  }
  .brand{
    display:flex; gap:12px; align-items:center;
    margin-bottom:12px;
  }
  .logo{
    width:64px; height:64px; border-radius:12px;
    background: radial-gradient(circle at 30% 20%, rgba(255,255,255,0.08), rgba(255,255,255,0.02));
    display:flex; align-items:center; justify-content:center;
    font-weight:700; font-size:18px;
    box-shadow: inset 0 -6px 16px rgba(0,0,0,0.4);
    border: 1px solid rgba(255,255,255,0.04);
    transform: rotate(-8deg);
  }
  .brand h1{font-size:16px;margin:0}
  .brand p{margin:0;color:var(--muted);font-size:13px}

  .hero .big{
    font-size:22px; margin-top:16px; line-height:1.1;
  }
  .hero p.lead{color:var(--muted); margin-top:12px; font-size:15px}

  .decor {
    position:absolute; right:-40px; top:-40px; width:260px; height:260px;
    background:radial-gradient(circle at 30% 30%, rgba(0,184,148,0.06), transparent 20%),
               conic-gradient(from 200deg at 50% 50%, rgba(0,0,0,0.06), transparent 50%);
    filter: blur(24px);
    transform: rotate(15deg);
    pointer-events:none;
  }

  /* --- Right panel (form) --- */
  .card{
    background: linear-gradient(180deg,var(--card), rgba(7,14,24,0.8));
    padding:20px;
    border-radius:14px;
    border:1px solid var(--glass);
    box-shadow: 0 8px 40px rgba(2,6,12,0.6);
    backdrop-filter: blur(6px);
  }
  form{display:flex;flex-direction:column; gap:12px}
  label{font-size:12px;color:var(--muted); margin-bottom:6px}
  input, select, textarea{
    width:100%; padding:12px 14px; border-radius:10px; border:1px solid var(--glass-2);
    background: rgba(255,255,255,0.02); color: #eaf6ff; font-size:15px;
    outline:none;
    transition: transform .15s ease, box-shadow .15s ease;
  }
  input:focus{transform: translateY(-2px); box-shadow: 0 8px 30px rgba(0,0,0,0.6)}
  .row{display:flex;gap:8px}
  .row .col{flex:1}

  .static-address{
    font-size:13px;color:var(--muted);padding:10px;border-radius:10px;background:rgba(255,255,255,0.015);
    border:1px dashed rgba(255,255,255,0.02);display:flex;align-items:center;gap:10px;
  }

  .btn{
    padding:12px 14px;border-radius:12px;border:0;font-weight:700;font-size:15px;
    cursor:pointer;
    background: linear-gradient(90deg,var(--accent), #00d39f);
    color:#042024;
    box-shadow: 0 8px 30px rgba(0,184,148,0.12), inset 0 -6px 20px rgba(255,255,255,0.03);
    transition: transform .14s ease;
  }
  .btn:active{transform:translateY(2px)}
  .btn.secondary{
    background: transparent; border:1px solid rgba(255,255,255,0.06); color:var(--muted);
  }

  .clients-list{margin-top:14px; max-height:240px; overflow:auto; padding-right:6px}
  .client-item{
    display:flex; justify-content:space-between; align-items:center; gap:10px;
    padding:10px;border-radius:10px;margin-bottom:8px;background:rgba(255,255,255,0.02);
    border:1px solid rgba(255,255,255,0.02);
  }
  .small{font-size:13px;color:var(--muted)}

  /* toast */
  .toast{
    position:fixed; left:50%; transform:translateX(-50%); bottom:24px;
    background:rgba(2,9,16,0.9); color:#e6f7ef; padding:10px 16px;border-radius:10px;
    box-shadow:0 8px 40px rgba(0,0,0,0.6); border:1px solid rgba(255,255,255,0.03);
    display:none; z-index:9999;
  }

  /* animations */
  @keyframes appear { from {opacity:0; transform: translateY(8px)} to{opacity:1; transform:none} }
  .pulse{ animation: pulse 2.6s infinite; }
  @keyframes pulse { 0%{ transform:scale(1)} 50%{transform:scale(1.02)} 100%{transform:scale(1)} }

  footer{margin-top:12px;font-size:12px;color:var(--muted)}
  .actions{display:flex; gap:8px; margin-top:8px}

  .hint{font-size:12px;color:rgba(255,255,255,0.55); margin-top:6px}

  /* small screens: make inputs bigger tap targets */
  @media (max-width:520px){
    input,select,textarea{padding:16px;font-size:17px}
    .btn{padding:14px 16px;font-size:17px}
  }
</style>
</head>
<body>
<div class="wrap">
  <div class="hero">
    <div class="brand">
      <div class="logo">ДС</div>
      <div>
        <h1>Городская Служба ДТП | Воронеж</h1>
        <p>Аварийный комиссар — оперативная запись на осмотр</p>
      </div>
    </div>

    <div class="big">Быстрая запись клиента — отправка WhatsApp и уведомление в Telegram-бот.</div>
    <p class="lead">Заполните данные клиента → нажмите «Записать». Сайт работает как одностраничное приложение и адаптирован под iPhone.</p>

    <div class="decor"></div>

    <div style="margin-top:18px;">
      <div class="static-address">
        <div style="font-weight:700">Место осмотра:</div>
        <div style="flex:1">
          г. Воронеж, ул. Антонова-Овсиенко, 15А корпус 1
        </div>
      </div>
      <div class="hint">После записи откроется WhatsApp с готовым текстом. Также будет предпринята попытка отправить уведомление в Telegram-бот.</div>
    </div>
  </div>

  <div class="card">
    <form id="clientForm">
      <div>
        <label for="fio">ФИО</label>
        <input id="fio" name="fio" type="text" placeholder="Иванов Иван Иванович" required />
      </div>

      <div class="row">
        <div class="col">
          <label for="phone">Телефон (с кодом)</label>
          <input id="phone" name="phone" type="tel" placeholder="+7 900 000 00 00" required />
        </div>
        <div class="col">
          <label for="mark">Марка машины</label>
          <input id="mark" name="mark" type="text" placeholder="Lada Vesta" required />
        </div>
      </div>

      <div>
        <label for="plate">Гос. номер</label>
        <input id="plate" name="plate" type="text" placeholder="А000ВС36" required />
      </div>

      <div style="display:flex;gap:8px;margin-top:6px">
        <button class="btn" type="submit">Записать и открыть WhatsApp</button>
        <button id="clearBtn" type="button" class="btn secondary">Очистить форму</button>
      </div>

      <div style="margin-top:12px;">
        <div style="display:flex;align-items:center;justify-content:space-between">
          <div style="font-weight:700">Клиенты (локально)</div>
          <div class="small" id="clientsCount">0</div>
        </div>
        <div class="clients-list" id="clientsList" aria-live="polite"></div>
      </div>

      <footer>
        <div>Версия: <strong>1.0</strong> • Офлайн-ready • Адаптация для iPhone</div>
      </footer>
    </form>
  </div>
</div>

<div class="toast" id="toast">Готово</div>

<script>
/* ===========================
   Конфигурация (ВАЖНО)
   Если вы не хотите хранить токен в клиенте — оставьте пустыми и используйте ручный режим.
   =========================== */
const TELEGRAM_BOT_TOKEN = "8178506125:AAEmv2tbPBKlu7YChH30B-M3EOsGG_5gxsA"; // <- ваш токен (внимание: публично видно)
const TELEGRAM_CHAT_ID   = "881133631"; // <- ваш chat id

/* Адрес осмотра (статический) */
const STATIC_ADDRESS = "г. Воронеж, ул. Антонова-Овсиенко, 15А корпус 1";

/* Utils */
const toast = (msg, time=3000) => {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.style.display = 'block';
  setTimeout(()=> t.style.display = 'none', time);
}

function phoneDigitsOnly(p){
  return p.replace(/[^+\d]/g,'');
}

/* localStorage for clients */
const LS_KEY = 'dps_clients_vrn';
function loadClients(){
  try{
    return JSON.parse(localStorage.getItem(LS_KEY)||'[]');
  }catch(e){ return [] }
}
function saveClients(arr){
  localStorage.setItem(LS_KEY, JSON.stringify(arr));
}

/* render clients list */
function renderClients(){
  const list = document.getElementById('clientsList');
  const arr = loadClients();
  list.innerHTML = '';
  arr.slice().reverse().forEach((c, idx)=>{
    const div = document.createElement('div');
    div.className = 'client-item';
    div.innerHTML = \`
      <div>
        <div style="font-weight:700">\${c.fio}</div>
        <div class="small">\${c.phone} — \${c.mark} / \${c.plate}</div>
      </div>
      <div style="display:flex;flex-direction:column;gap:6px;align-items:flex-end">
        <div class="small">\${new Date(c.addedAt).toLocaleString()}</div>
        <div style="display:flex;gap:6px">
          <button data-index="\${arr.length-1-idx}" class="btn secondary copyBtn">Копировать</button>
          <button data-index="\${arr.length-1-idx}" class="btn" style="padding:6px 10px" title="Удалить">✕</button>
        </div>
      </div>\`;
    list.appendChild(div);
  });
  document.getElementById('clientsCount').textContent = loadClients().length;
}

/* initial render */
renderClients();

/* form logic */
document.getElementById('clientForm').addEventListener('submit', async function(e){
  e.preventDefault();
  const fio = document.getElementById('fio').value.trim();
  const phoneRaw = document.getElementById('phone').value.trim();
  const phone = phoneDigitsOnly(phoneRaw);
  const mark = document.getElementById('mark').value.trim();
  const plate = document.getElementById('plate').value.trim();

  if(!fio || !phone || !mark || !plate){
    toast('Заполните все поля');
    return;
  }

  // prepare text for WhatsApp and Telegram
  const whatsappText = 
    \`Здравствуйте, \${fio}!\nВы записаны на осмотр после ДТП.\n\nДата/время: (уточняется)\nМесто: \${STATIC_ADDRESS}\nМарка: \${mark}\nГос. номер: \${plate}\n\nСвяжемся для подтверждения.\`;

  // open WhatsApp (на iPhone откроется приложение WhatsApp, если установлено)
  const waNumber = phone.replace(/[^0-9]/g,'');
  // if number starts with 8 but not with +7, transform? we rely on user entering +7...
  const waUrl = 'https://wa.me/' + waNumber + '?text=' + encodeURIComponent(whatsappText);
  window.open(waUrl, '_blank');

  // save locally
  const clients = loadClients();
  clients.push({fio, phone, mark, plate, addedAt: new Date().toISOString()});
  saveClients(clients);
  renderClients();
  toast('Клиент сохранён локально. Попытка отправить уведомление в Telegram...');

  // try to send to Telegram Bot API
  const tgMessage = \`Новая запись на осмотр:\n\${fio}\nТелефон: \${phone}\nМарка: \${mark}\nГосномер: \${plate}\nМесто: \${STATIC_ADDRESS}\nВремя записи: \${new Date().toLocaleString()}\`;

  // if token or chat id not provided - fallback
  if(!TELEGRAM_BOT_TOKEN || !TELEGRAM_CHAT_ID){
    toast('Токен Telegram не задан — автоматическая отправка не выполнена',5000);
    // copy message to clipboard for manual paste
    try{ await navigator.clipboard.writeText(tgMessage); toast('Текст для Telegram скопирован в буфер обмена'); }catch(e){}
    return;
  }

  // Attempt fetch POST to Telegram API
  try{
    const apiUrl = 'https://api.telegram.org/bot' + TELEGRAM_BOT_TOKEN + '/sendMessage';
    const resp = await fetch(apiUrl, {
      method:'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ chat_id: TELEGRAM_CHAT_ID, text: tgMessage.replace(/\\n/g,'\\n') })
    });
    if(resp.ok){
      const j = await resp.json();
      if(j && j.ok){
        toast('Уведомление отправлено в Telegram-бот ✅',4000);
      } else {
        console.warn('Telegram response not ok', j);
        throw new Error('Telegram error');
      }
    } else {
      console.warn('Telegram fetch failed', resp.status);
      throw new Error('Telegram fetch failed: ' + resp.status);
    }
  }catch(err){
    console.error('Не удалось отправить в Telegram:', err);
    // CORS or blocked; provide fallback
    toast('Авто-отправка в Telegram не удалась (CORS/блокировка). Скопировано сообщение для ручной отправки.',6000);
    try{
      await navigator.clipboard.writeText(tgMessage);
    }catch(e){
      // ignore
    }
    // show modal-like prompt with tgMessage and copy button
    showFallbackModal(tgMessage);
  }
});

/* clear form */
document.getElementById('clearBtn').addEventListener('click', ()=>{
  document.getElementById('fio').value='';
  document.getElementById('phone').value='';
  document.getElementById('mark').value='';
  document.getElementById('plate').value='';
});

/* list actions: delegate */
document.getElementById('clientsList').addEventListener('click', async (e)=>{
  const btn = e.target.closest('button');
  if(!btn) return;
  const idx = btn.getAttribute('data-index');
  if(btn.classList.contains('copyBtn')){
    const arr = loadClients();
    const c = arr[idx];
    const txt = c ? \`Запись: \${c.fio} | \${c.phone} | \${c.mark} | \${c.plate} | \${STATIC_ADDRESS}\` : '';
    try{ await navigator.clipboard.writeText(txt); toast('Скопировано'); }catch(e){ toast('Не удалось скопировать'); }
    return;
  }
  // delete button
  if(btn.textContent.trim() === '✕'){
    if(confirm('Удалить запись?')){
      const arr = loadClients();
      arr.splice(idx,1);
      saveClients(arr);
      renderClients();
      toast('Запись удалена');
    }
  }
});

/* fallback modal */
function showFallbackModal(message){
  let el = document.getElementById('fallbackModal');
  if(el){ el.remove(); }
  el = document.createElement('div');
  el.id = 'fallbackModal';
  el.style.position='fixed';
  el.style.left=0; el.style.top=0; el.style.right=0; el.style.bottom=0;
  el.style.display='flex'; el.style.alignItems='center'; el.style.justifyContent='center';
  el.style.background='rgba(2,6,12,0.6)'; el.style.zIndex=99999;
  el.innerHTML = \`
    <div style="width:92%;max-width:720px;background:linear-gradient(180deg,#061018,#07121A);border-radius:12px;padding:16px;border:1px solid rgba(255,255,255,0.04);box-shadow:0 12px 60px rgba(0,0,0,0.7)">
      <h3 style="margin:0 0 8px 0">Ручная отправка в Telegram</h3>
      <p style="margin:0 0 12px 0;color:rgba(255,255,255,0.7)">Автоматическая отправка была заблокирована браузером (CORS) или не удалась. Скопируйте сообщение и вставьте его в чат с ботом.</p>
      <textarea id="fbText" style="width:100%;height:160px;border-radius:8px;padding:10px;background:rgba(255,255,255,0.02);color:#eaf6ff;border:1px solid rgba(255,255,255,0.03)">\${message}</textarea>
      <div style="display:flex;gap:8px;margin-top:10px;justify-content:flex-end">
        <button id="copyFb" class="btn secondary">Копировать</button>
        <button id="openTgWeb" class="btn secondary">Открыть Telegram Web</button>
        <button id="closeFb" class="btn">Закрыть</button>
      </div>
    </div>
  \`;
  document.body.appendChild(el);
  document.getElementById('copyFb').addEventListener('click', async ()=>{
    try{ await navigator.clipboard.writeText(document.getElementById('fbText').value); toast('Скопировано в буфер'); }catch(e){ toast('Не удалось'); }
  });
  document.getElementById('openTgWeb').addEventListener('click', ()=>{
    // open t.me — user needs to paste message in bot chat
    window.open('https://web.telegram.org/k/', '_blank');
  });
  document.getElementById('closeFb').addEventListener('click', ()=> el.remove());
}

/* initial small animation for logo */
document.querySelector('.logo').classList.add('pulse');
setTimeout(()=>document.querySelector('.logo').classList.remove('pulse'), 2600);
</script>
</body>
</html>
